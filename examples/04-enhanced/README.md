# 增强功能示例

本示例展示了线程安全抽奖系统的增强功能，包括错误恢复、状态管理和性能优化。

## 功能演示

1. **错误恢复连抽** - 带错误恢复功能的连续抽奖
2. **进度回调优化** - 带实时进度显示的优化连抽
3. **奖品池错误处理** - 奖品池连抽的错误恢复
4. **详细错误信息** - 完整的错误详情和时间戳
5. **状态管理** - 抽奖状态的保存和恢复（演示接口）

## 运行示例

```bash
cd examples/04-enhanced
go run main.go
```

## 增强特性

### 错误恢复
- **部分成功处理**: 即使部分抽奖失败，也返回成功的结果
- **成功率统计**: 提供详细的成功率计算
- **错误详情**: 包含每个失败抽奖的详细信息和时间戳

### 性能优化
- **批量处理**: 优化大量连续抽奖的性能
- **进度回调**: 实时显示抽奖进度
- **内存优化**: 减少内存分配和垃圾回收

### 状态管理
- **状态保存**: 保存当前抽奖操作的状态
- **状态恢复**: 从中断点恢复抽奖操作
- **进度跟踪**: 详细的进度和时间信息

## 数据结构

### MultiDrawResult
```go
type MultiDrawResult struct {
    Results        []int       // 成功的范围抽奖结果
    PrizeResults   []*Prize    // 成功的奖品抽奖结果
    TotalRequested int         // 请求的总次数
    Completed      int         // 成功完成的次数
    Failed         int         // 失败的次数
    PartialSuccess bool        // 是否为部分成功
    LastError      error       // 最后一个错误
    ErrorDetails   []DrawError // 详细错误信息
}
```

### DrawState
```go
type DrawState struct {
    LockKey        string    // 锁键名
    TotalCount     int       // 总抽奖次数
    CompletedCount int       // 已完成次数
    Results        []int     // 当前结果
    StartTime      int64     // 开始时间
    LastUpdateTime int64     // 最后更新时间
}
```

## 示例输出

```
=== 增强的连抽错误处理示例 ===

1. 带错误恢复的范围连抽:
全部成功: [42 73 15 89 34 67 91 28 56 12]

2. 带进度回调的优化连抽:
进度: 20.0% (1/5) - 当前结果: 23
进度: 40.0% (2/5) - 当前结果: 47
进度: 60.0% (3/5) - 当前结果: 8
进度: 80.0% (4/5) - 当前结果: 35
进度: 100.0% (5/5) - 当前结果: 19
优化连抽完成: [23 47 8 35 19]

3. 奖品池连抽与错误处理:
奖品连抽全部成功:
  第1次: 安慰奖 (价值: 10)
  第2次: 铜奖 (价值: 100)
  第3次: 银奖 (价值: 500)
  第4次: 安慰奖 (价值: 10)
  第5次: 铜奖 (价值: 100)
  第6次: 安慰奖 (价值: 10)
  第7次: 金奖 (价值: 1000)
  第8次: 铜奖 (价值: 100)

4. 错误详情示例:
预期的错误: draw operation was interrupted

5. 状态保存和恢复演示:
保存状态: 进度 60.0% (6/10)
状态保存成功
未找到保存的状态（这是预期的，因为当前实现是占位符）

=== 增强功能演示完成 ===
```

## 使用场景

- **高可靠性场景**: 需要确保抽奖操作的完整性
- **大批量抽奖**: 需要处理大量连续抽奖请求
- **实时监控**: 需要实时了解抽奖进度和状态
- **故障恢复**: 需要从中断点恢复抽奖操作